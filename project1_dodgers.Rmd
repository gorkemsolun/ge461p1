---
title: <center> <h2> Spring 2024 - GE 461 Introduction to Data Science</h2> Dodgers Exploratory Data Analysis   </center>
pagetitle: 
author: <center> İsmail Kaan Özer 22002672, Görkem Kadir Solun 22003214</center>
always_allow_html: true
linkcolor: red
output: 
  bookdown::html_document2:
    theme: readable
    number_sections: false
    code_folding: "hide"
    toc: true
  bookdown::pdf_document2:
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RSQLite)
library(DBI)
library(tidyverse)
library(pander)

con <- dbConnect(SQLite(),"data/dodgers.sqlite")
dbListTables(con)

tbl(con, "events") %>% 
  collect() %>% 
  mutate(day_of_week = factor(day_of_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
         month = factor(month, levels = c("APR","MAY","JUN","JUL","AUG","SEP","OCT"))) %>% 
  mutate_if(is.character, factor) %>% 
  mutate(temp = round((temp- 32)*5/9)) -> events
  
```

# Introduction

The Los Angeles Dodgers Baseball team gathered data from their 81 games to analyze. The objective is to increase attendance at the matches. Temperature and Attendance variables are quantitative, while all others are qualitative. The specific analysis target is measuring the effects of all variables on the attendance variable. Below is the summary of the data set.

```{r}
summary(events)
```

# Visualizing and Evaluating Different Variables

To observe whether different variables increase attendance, Chi-squared tests and Welch’s Two Sample t-tests were conducted on variables and attendance. 

## Booblehead

Firstly, we need to visualize the attendance with bobblehead promotion existence; then, we can decide whether there was a correlation between the attendance and bobblehead promotions.

```{r}
events %>% 
  ggplot(aes(bobblehead, attend)) +
  geom_boxplot()
```

The graph suggests that there is a difference. However, to be sure, a Chi-squared test was conducted between attendance and bobblehead promotions.

```{r}
events %>% 
  group_by(bobblehead) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
Similar to the previous test, the results strongly suggest that bobblehead promotions positively impact attendance. The test showed a clear connection between promotions and attendance numbers. Our p-value is near zero, so we are confident that bobblehead promotions will increase attendance.

## Fireworks

Like the bobblehead, firstly, we need to visualize the attendance with the fireworks' existence, and then we can decide whether there was a correlation between the attendance and fireworks.

```{r}
events %>% 
  ggplot(aes(fireworks, attend)) +
  geom_boxplot()
```

In contrast to bobbleheads, the graph suggests that there is no difference. However, to be sure, the Welch Two Sample t-test and Chi-squared test was conducted between attendance and fireworks.

```{r}
t.test(x=events$attend[events$fireworks=="YES"], y=events$attend[events$fireworks=="NO"])
```

A statistical test (t-test) was done, and the results suggest that fireworks have little to no impact on attendance. It is seen that there is enough evidence to conclude that there isn’t a relation between attendance and fireworks, considering the p-value of the test is almost 1. The test showed no connection between fireworks and attendance numbers.

A Chi-squared test was also conducted to double check whether there is a connection between fireworks and attendance numbers.

```{r}
events %>% 
  group_by(fireworks) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```

Similar to the previous test, the results suggest that bobblehead promotions have little to no impact on attendance. The test showed no apparent connection between fireworks and attendance numbers. Our p-value is near one, meaning we are confident that fireworks are unrelated to attendance.

## Shirt

Firstly, we need to visualize the attendance with shirt promotion existence, and then we can decide whether there is a correlation between attendance and shirt promotions.

```{r}
events %>% 
  ggplot(aes(shirt, attend)) +
  geom_boxplot()
```

The graph suggests that there is a difference. However, again, to be sure, a Chi-squared test was also conducted to check whether there is a connection between shirt promotions and attendance numbers.

```{r}
events %>% 
  group_by(shirt) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
The results strongly suggest that shirt promotions positively impact attendance. The test showed a connection between shirt promotions and attendance numbers. Our p-value is near zero, so we are confident that there is difference and shirt promotions will increase attendance.

The Chi-squared test reveals an important relationship between attendance and receiving a shirt. This might mean that people with higher attendance have a higher chance of getting a shirt, even if the mean differences are subtle.

Therefore, we will focus on our results in Chi-squared tests and consider shirt relations in attendance.

## Cap

Firstly, we need to visualize the attendance with the existence of cap promotions, and then we can decide whether there is a correlation between attendance and cap promotions.

```{r}
events %>% 
  ggplot(aes(cap, attend)) +
  geom_boxplot()
```

The graph suggests that there is difference. However, again, to be sure, a Chi-squared test was also conducted to check whether there is a connection between cap promotions and attendance numbers.

```{r}
events %>% 
  group_by(cap) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
The results suggest that cap promotions have a positive impact on attendance. The test showed a connection between cap promotions and attendance numbers. Our p-value is near zero, so we are confident that cap promotions will increase attendance.

The Chi-squared test reveals an important relationship between attendance and receiving a cap. This might mean that people with higher attendance have a higher chance of getting a cap, even if the mean differences are subtle.

Therefore, we will consider cap relations in attendance.

## Day and Night

Firstly, we need to visualize the attendance day and night; then, we can decide whether there was a correlation between the attendance and day or night.

```{r}
events %>% 
  ggplot(aes(day_night, attend)) +
  geom_boxplot()
```

The graph suggests that there is very small to no difference. However, again, to be sure, a Chi-squared test was conducted to check whether there is a connection between day or night and attendance numbers.

```{r}
events %>% 
  group_by(day_night) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
In contrast to the graph, the results suggest that being day or night have a impact on attendance. The test showed a connection between being day or night and attendance numbers. Our p-value is near zero meaning we are confident that being day or night related to attendance.

Therefore, we will consider day and night relations in attendance.

## Skies

Firstly, we need to visualize the attendance with skies; then, we can decide whether there was a correlation between the attendance and sky.

```{r}
events %>% 
  ggplot(aes(skies, attend)) +
  geom_boxplot()
```

The graph suggests that there is small difference. However, again, to be sure, a Chi-squared test was conducted to check whether there is a connection between sky and attendance numbers.

```{r}
events %>% 
  group_by(skies) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
In contrast to the graph, the results suggest that skies have a impact on attendance. The test showed a connection between sky and attendance numbers. Our p-value is near zero meaning we are confident that sky is related to attendance.

Therefore, we will consider skies relations in attendance.

## Temperature

Firstly, we need to visualize the attendance with temperature; then, we can decide whether there was a correlation between the attendance and temperature.

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_point() +
  geom_smooth(se=FALSE)
```

The graphs suggests a difference, particularly around 22-23 degrees. We can see higher averages of attendance. Therefore, we will consider temperature relations in attendance.

### Temperature with other variables

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_jitter(aes(col = opponent)) +
  geom_text(aes(label = str_sub(opponent, 1,4), col = opponent)) +
  geom_smooth(se = FALSE)
```
Here, we displayed the opponents, temperature, and attendance. Many variances exist, so we should explore this further by considering these variables.

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_jitter(aes(col = bobblehead)) +
  geom_smooth(se = FALSE)
```


Here, we can see how the day and night temperature varies through the months.

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_jitter(aes(col = day_of_week)) +
  geom_text(aes(label = str_sub(day_of_week, 1,3), col = day_of_week)) +
  geom_smooth(se = FALSE)
```

Temperature and days of the week of the games played against attendance.

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_jitter(aes(col = month)) +
  geom_text(aes(label = str_sub(month, 1,3), col = month)) +
  geom_smooth(se = FALSE)
```

Temperature and months of the games played against attendance.

```{r}
events %>% 
  ggplot(aes(temp, attend)) +
  geom_jitter(aes(col = bobblehead)) +
  geom_smooth(se = FALSE)
```


## Days and Month

Firstly, we need to visualize the attendance with dates; then, we can decide whether there was a correlation between the attendance.

```{r}
events %>%
mutate(day_of_week = factor(day_of_week, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) %>%
count(day_of_week, name = "Number of games") %>%
rename(`Week day`= day_of_week) %>%
pander(caption = "Number of games on week days")
```
The games were played uniformly every weekday except Thursday, which has less than other days. 

```{r}
events %>%
mutate(month = factor(month, levels = c("APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT"))) %>%
count(month, name = "Number of games") %>%
rename(`Month`= month) %>%
pander(caption = "Number of games across months")

```
May hosted the most significant number of games, while October the least. June has as much as half of the games in May. The remainder of the months have high and similar game numbers.

This heatmap shows total attendance versus weekday and month. The colors change from bright yellow to dark red as attendance increases. Default heatmap shuffles rows and columns to bring together weekdays and months with similar attendance. Here, we see May, Aug, and Jul together within the months and Saturday, Friday, and Sunday within the weekdays.

```{r}
xtabs(attend ~ day_of_week + month, events) %>% 
  heatmap()
```

The heatmap suggests a difference. For example, attendance is low in October, and we can see there is higher attendance on Monday, Tuesday, and Wednesday in July. Still, on other days, attendance is low. Therefore, we will consider dates, months, and days relations in attendance.

We can also draw a graph to see how attendance varies across the days of the week.

```{r}
events %>% 
  ggplot(aes(day_of_week, attend)) +
  geom_boxplot()
```

Here, we can see that we see a higher average on Tuesdays and a lower average on Mondays.

## Opponents

Firstly, we need to visualize the attendance with opponents; then, we can decide whether there was a correlation between the attendance and opponents.

```{r}
events %>% 
  ggplot(aes(opponent, attend)) +
  geom_boxplot()
```

The graph suggests that there is difference. However, again, to be sure, a Chi-squared test was conducted to check whether there is a connection between opponents and attendance numbers.

```{r}
events %>% 
  group_by(opponent) %>% 
  summarize(avgattend = mean(attend)) %>% 
  pull(avgattend) %>% chisq.test()
```
Same as the graph, the results suggest that opponents have a impact on attendance. The test showed a connection between opponents and attendance numbers. Our p-value is near zero meaning we are confident that opponent is related to attendance.

Therefore, we will consider opponents relations in attendance.

# Linear Regression Model and Validating

First, we regress attendance on month, day of the week, and boblehead.

```{r}
model <- lm(attend ~ month + day_of_week + bobblehead, data = events)
summary(model)
```

We test the null hypothesis, "Giving bobblehead has no effect on attendance," in the summary table along the lines of the bobbleheadYES. If the p-value on the same line is significant (> 0.05), then the null and the data are consistent. We reject the null if the p-value is small because the data contradicts the null. We reject the null since the p-value is very small. Consequently, we draw the conclusion that bobbleheads have an impact on attendance, although a favorable one given the estimate's positive value of 10714.90. On average, we anticipate a 10715 rise in attendance.

Plotting our model

```{r}
plot(model)
```


Again, we need look at which criteria in the dataset affected attendance to make sure that variables do not coincide with other factors in a way that could skew this test. To do this, a multiple regression model was developed that included all criteria and removed them one at a time until the results stopped getting better. The model was trained using a random selection of 80% of the dataset; the remaining games were utilized to assess the accuracy of the predictions.

```{r}
set.seed(666)
smp_size <- floor(0.80 * nrow(events))

train_ind <- sample(seq_len(nrow(events)), size = smp_size)

train <- events[train_ind, ]
test <- events[-train_ind, ]

model1 <- lm(formula = attend ~ month + day + day_of_week + opponent + temp + skies + day_night + cap + shirt + fireworks + bobblehead, data = events)

summary(model1)

#plot(model1) # I don't know whether this is useful or not. fireworks and month
```

In the summary table, on the lines of bobbleheadYES, we test the null hypothesis: “Giving bobblehead has no effect on attendance”. Null and data are consistent if p-value on the same line is large (> 0.05). If p-value is small, then data contradicts with the null, and therefore we reject the null. Since p-value = 0.0000359 is indeed small we reject the null. So we conclude that bobblehead can affect the attendance (in the positive direction because the estimate has positive value 10714.90). We expect the attendance to increase by 10715 on average.

The model is tested and are compared using the Mean Absolute Error. A train sample and a test sample were randomly selected from the dataset using the same seed, ensuring consistency across all model tests.

```{r}
prediction <- predict(model1,test)

mean(abs(prediction-test$attend))
```










```{r}
lm1 <- lm(attend ~ ., events)
summary(lm1)
```


```{r}
anova(lm1)
```

```{r}
dbDisconnect(con)
```

